# ACM Hive Cluster

## Description
The `acm_hive_cluster` role prepares and deploys clusters on a Hub cluster.

## Role Variables
#### State
State of the hive clusters. Could be "present" or "absent".
```
state: present
```

#### OpenShift pull secret
The pull secret is used to authenticate with the services that are provided by the included authorities, `Quay.io` and `registry.redhat.io`, which serve the container images for OpenShift Container Platform components.  
Use the following link to obtain the pull-secret - https://console.redhat.com/openshift/install/pull-secret  
The variable is mandatory.
```
pull_secret:
```

#### SSH Public key
The ssh public key pushed to the cluster nodes during deploy and used to access the nodes.  
The variable is mandatory.
```
ssh_pub_key:
```

#### ACM Hive clusters
Defines hive clusters that should be deployed on the Hub.
**Note** - For more provides and override options, refer to `config-sample.yml` file.
```
acm_hive_clusters:
  - name: cluster1
    credentials: cluster1-creds
    platform: aws
    region: us-east-2
    network:
      cluster: 10.128.0.0/14
      machine: 10.0.0.0/16
      service: 172.30.0.0/16
      type: OVNKubernetes
    hive_cluster_image: quay.io/openshift-release-dev/ocp-release:4.12.7-multi
    fips: true  # Optional variable to enable FIPS on cluster
```

#### Clusters credentials
Define credentials that will be used by the hive clusters during creation.
**Note** - For more provides and override options, refer to `config-sample.yml` file.
```
acm_hive_clusters_credentials:
  - name: cluster1-creds
    platform: aws
    namespace: open-cluster-management-hub
    base_domain:
    aws_access_key_id:
    aws_secret_access_key:
```

***
The role is able to work in one of the following states:
* Newly deployed cluster.  
  The cluster will be deployed by the [ocp](ocp.md) role and generate `clusters_details_file`.  
  Clusters info will be fetched from this file to generate the token for the next tasks.
* Existing cluster.  
  If the cluster already exists and was not deployed by us, token could be generated by providing the following environment variables prior playbook execution.
  ```bash
  export OC_CLUSTER_API=<ocp_cluster_api>
  export OC_CLUSTER_USER=<ocp_cluster_user>
  export OC_CLUSTER_PASS=<ocp_cluster_pass>

  ansible-playbook playbook.yml -e @config.yml
  ```

***
The variables could be applied to the playbook run, by saving them into a separate yml file and include the file during the playbook execution.  
Note the '@' sign, which is used to apply the variables located within the provided file.

```
ansible-playbook playbooks/acm_hive_cluster.yml -e @/path/to/the/variable/file.yml
```
